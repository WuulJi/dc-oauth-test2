<!-- Generated by SpecStory -->

# Firebase Authentication Custom Token Issues (2025-05-05 23:53:07)

_**User**_

現在使用者登入後，authentication 會記錄使用者資訊如圖，我想問 ID 和識別資訊提供者為什麼是空的? 

---

_**Assistant**_

根據你提供的 Firebase Authentication 後台截圖，ID 和識別資訊提供者（Provider）欄位是空的，這通常有以下幾個常見原因：

### 1. 使用自訂認證（Custom Token）
你目前的登入流程是「Discord OAuth2 → 後端產生 Firebase Custom Token → 前端用 custom token 登入 Firebase」。  
這種方式下，Firebase Authentication 只會記錄一個 UID，並不會自動記錄 email、provider（如 google.com、discord.com 等）等資訊，因為這些資訊不是由 Firebase Auth 內建的 provider 產生的，而是你自訂的。

- **ID** 欄位：通常會顯示 email 或 phone，但 custom token 沒有這些欄位就會是 `-`。
- **識別資訊提供者**：custom token 登入時 provider 會是 `custom`，但 UI 上通常不顯示，或顯示為空。

### 2. 沒有設置 email 或 phone
如果你在產生 custom token 時沒有在 claims 裡面加上 email 或 phone，Firebase Auth 就不會顯示這些資訊。

---

## 如何驗證

你可以在 Firebase Authentication 後台，點進該使用者的詳細資料，應該只會看到 UID，沒有 email、providerId 等欄位。

---

## 解決方式（如果你想顯示 email 或 provider）

1. **在 custom token 的 claims 裡加上 email**  
   但這只會讓你在 Firestore 或 Realtime Database 查到 email，Firebase Auth 後台還是不會顯示 email，因為 custom token 只會產生 UID。

2. **同步 email 到 Firestore**  
   你可以在登入時，把 Discord 的 email、provider 等資訊同步到 Firestore 的 `users` collection，這樣你可以在自己的管理後台查到。

3. **如果想要 providerId 顯示為 discord.com**  
   你必須寫一個 Firebase Auth 的自訂 provider（很麻煩），或直接用 Firestore 管理。

---

## 結論

- 你現在看到的現象（ID 和識別資訊提供者為空）是正常的，因為你是用 custom token 登入。
- Firebase Auth 只會記錄 UID，其他資訊要你自己同步到 Firestore 或其他資料庫。

如果你需要更詳細的技術解釋或想要同步 email/provider 到 Firestore，請告訴我你的需求！

---

_**User**_

我想用第2個解決方法，將使用者的discord id 同步記錄到 firestore，該怎麼做?

---

_**Assistant**_

你想要在使用者登入時，將 Discord 的 ID（或其他資訊）同步到 Firestore。這是很常見的做法，步驟如下：

---

## 步驟說明

1. **後端在產生 custom token 時，將 Discord 使用者資訊（如 Discord ID）一併回傳給前端。**
2. **前端在登入 Firebase 成功後，把這些資訊寫入 Firestore 的 `users` collection。**

---

## 具體做法

### 1. 後端回傳 Discord 資訊

假設你後端 `/auth/discord/callback` 會回傳：
```json
{
  "token": "firebase_custom_token",
  "discord": {
    "id": "1234567890",
    "username": "myname",
    "avatar": "https://cdn.discordapp.com/avatars/...",
    ...
  }
}
```

### 2. 前端登入後寫入 Firestore

在 `public/index.html` 的 JS 裡，登入成功後寫入 Firestore：

#### 假設你已經拿到 Discord 資訊（如上），可以這樣寫：

```js
// 假設你已經有 discordUser 物件
firebase.auth().signInWithCustomToken(token)
  .then((userCredential) => {
    // 取得 Firebase UID
    const uid = userCredential.user.uid;
    // 寫入 Firestore
    return firebase.firestore().collection('users').doc(uid).set({
      discordId: discordUser.id,
      username: discordUser.username,
      avatar: discordUser.avatar,
      discriminator: discordUser.discriminator,
      // 你想同步的其他欄位
    }, { merge: true });
  })
  .then(() => {
    // Firestore 寫入成功
    // 可以呼叫 loadUserData(uid) 或刷新頁面
  })
  .catch((error) => {
    // 處理錯誤
    document.getElementById('errorMessage').textContent = 'Error signing in: ' + error.message;
  });
```

---

## 你需要調整的地方

1. **確保後端有把 Discord 使用者資訊回傳給前端。**
2. **前端在登入 Firebase 成功後，將 Discord ID 等資訊寫入 Firestore。**

---

## 範例流程

1. 使用者用 Discord 登入，後端回傳 custom token 和 Discord user info。
2. 前端用 custom token 登入 Firebase。
3. 登入成功後，將 Discord user info 寫入 Firestore 的 `users/{uid}` 文件。

---

如果你需要具體的程式碼範例（例如如何取得 discordUser 物件，或如何串接後端 API），請提供你目前的前端登入流程程式碼，我可以幫你補上完整範例！

---

_**User**_

先幫我確認discord是否會回傳

---

_**Assistant**_

<details>
            <summary>Searched codebase "discord user info 回傳" • **23** results</summary>
        
| File | Lines |
|------|-------|
| `functions/index.js` | L81-122 |
| `dc-oauth-test.md` | L3036-3081 |
| `functions/index.js` | L122-162 |
| `dc-oauth-test.md` | L2102-2180 |
| `functions/index.js` | L162-199 |
| `public/index.html` | L218-242 |
| `dc-oauth-test-part2.md` | L4013-4066 |
| `public/index.html` | L130-173 |
| `public/index.html` | L173-218 |
| `dc-oauth-test-part2.md` | L2923-2986 |
| `dc-oauth-test.md` | L2032-2102 |
| `dc-oauth-test-part3.md` | L494-564 |
| `dc-oauth-test-part2.md` | L9579-9634 |
| `dc-oauth-test.md` | L105-180 |
| `dc-oauth-test-part3.md` | L564-627 |
| `dc-oauth-test.md` | L1986-2032 |
| `dc-oauth-test-part2.md` | L9453-9507 |
| `dc-oauth-test-part2.md` | L10225-10295 |
| `dc-oauth-test-part2.md` | L8579-8633 |
| `dc-oauth-test.md` | L230-289 |
| `dc-oauth-test-part2.md` | L3441-3512 |
| `dc-oauth-test.md` | L922-978 |
| `dc-oauth-test-part2.md` | L3385-3441 |

</details>

---

根據你提供的後端 Cloud Functions 日誌與程式碼，**Discord 會正確回傳使用者資訊**，而且你已經有在後端拿到這些資料。  
以下是日誌中的 Discord 回傳內容（`discordUser`）：

```json
{
  "id": "1092371877600702564",
  "username": "wuul_ji",
  "avatar": "81cff0dc5d1265be50249ad40b79ccd8",
  "discriminator": "0",
  "public_flags": 0,
  "flags": 0,
  "banner": null,
  "accent_color": 3833273,
  "global_name": "wuul_ji",
  "avatar_decoration_data": null,
  "collectibles": null,
  "banner_color": "#3a7db9",
  "clan": null,
  "primary_guild": null,
  "mfa_enabled": true,
  "locale": "zh-TW",
  "premium_type": 2,
  "email": "eragonsurain@gmail.com",
  "verified": true
}
```

### 結論
- 你的後端已經有正確取得 Discord 回傳的使用者資訊（包含 id、username、avatar、email 等）。
- 這些資訊也已經被寫入 Firestore 的 `users` collection。

你可以放心，**Discord 會回傳你需要的資訊**，你只要在前端或後端把這些資訊寫入 Firestore 即可。

如果你需要在 Firestore 裡多存一個 `discordId` 欄位，只要在寫入時加上即可，例如：

```js
await admin.firestore().collection("users").doc(discordUser.id).set({
  discordId: discordUser.id, // 新增這一行
  username: discordUser.username,
  // ... 其他欄位
}, { merge: true });
```

如果你要在前端寫入 Firestore，也可以用同樣的方式加上 `discordId` 欄位。  
有需要範例請再告訴我！

---

_**User**_

將discord回傳的資訊寫入firestore，前端寫入跟後端寫入，哪個比較好?

---

_**Assistant**_

這是一個很常見的問題，以下是**前端寫入**和**後端寫入**的優缺點比較，並給你建議：

---

## 1. 後端寫入 Firestore（推薦！）

### 優點
- **安全性高**：只有後端能寫入，使用者無法偽造或竄改資料。
- **一致性好**：所有資料都來自 Discord API，可信度高。
- **流程集中**：OAuth 流程結束後，後端直接寫入 Firestore，減少前端負擔。
- **可控性強**：可以在後端做更多驗證、日誌、資料處理。

### 缺點
- 需要在 Cloud Functions 或自己的伺服器上寫入 Firestore 程式碼。

---

## 2. 前端寫入 Firestore

### 優點
- **實作簡單**：前端直接拿到資料就寫入 Firestore。
- **即時互動**：前端可以即時更新畫面和 Firestore。

### 缺點
- **安全性低**：使用者可以用瀏覽器工具竄改資料再寫入 Firestore（即使有 rules，還是有風險）。
- **資料可信度低**：你無法保證資料一定來自 Discord API，可能被偽造。
- **API Key 暴露**：雖然 Firestore rules 可以限制，但還是有被濫用的風險。

---

## **最佳實踐建議**

- **建議用後端寫入 Firestore！**
  - 你已經在 Cloud Functions 拿到 Discord 的資料，直接在那裡寫入 Firestore 是最安全、最正確的做法。
  - 前端只負責顯示資料，不負責寫入 Discord 相關的敏感資訊。

---

## **總結**

- **後端寫入**：安全、可信、推薦。
- **前端寫入**：方便但不安全，不建議用於 Discord OAuth 這種需要信任第三方資料的情境。

---

如需後端寫入 Firestore 的範例，或想知道如何加強 Firestore rules，歡迎再問我！

---

_**User**_

幫我完成從後端將discord 資訊寫入firebase的功能，資訊包含 id，username，email，3個就可以了

---

_**Assistant**_

<details>
            <summary>Searched codebase "firestore set discordUser" • **23** results</summary>
        
| File | Lines |
|------|-------|
| `dc-oauth-test-part2.md` | L4013-4066 |
| `dc-oauth-test.md` | L1874-1934 |
| `functions/index.js` | L162-199 |
| `functions/index.js` | L122-162 |
| `dc-oauth-test.md` | L3036-3081 |
| `dc-oauth-test.md` | L1986-2032 |
| `dc-oauth-test-part2.md` | L3441-3512 |
| `dc-oauth-test.md` | L2032-2102 |
| `public/index.html` | L218-242 |
| `dc-oauth-test-part2.md` | L3385-3441 |
| `dc-oauth-test-part2.md` | L9634-9668 |
| `dc-oauth-test-part2.md` | L4830-4890 |
| `dc-oauth-test-part2.md` | L2923-2986 |
| `dc-oauth-test-part2.md` | L3691-3744 |
| `public/js/config.js` | L1-17 |
| `dc-oauth-test-part2.md` | L9453-9507 |
| `dc-oauth-test-part2.md` | L8579-8633 |
| `dc-oauth-test.md` | L1934-1986 |
| `dc-oauth-test-part3.md` | L564-627 |
| `public/index.html` | L130-173 |
| `dc-oauth-test-part2.md` | L2986-3044 |
| `dc-oauth-test.md` | L922-978 |
| `dc-oauth-test.md` | L869-922 |

</details>

---

<details>
            <summary>Searched codebase "admin.firestore().collection("users").doc(discordUser.id).set" • **22** results</summary>
        
| File | Lines |
|------|-------|
| `functions/index.js` | L162-199 |
| `functions/index.js` | L122-162 |
| `public/index.html` | L218-242 |
| `dc-oauth-test-part2.md` | L4013-4066 |
| `dc-oauth-test.md` | L1874-1934 |
| `dc-oauth-test.md` | L3036-3081 |
| `dc-oauth-test-part2.md` | L3385-3441 |
| `dc-oauth-test.md` | L1986-2032 |
| `public/js/config.js` | L1-17 |
| `dc-oauth-test.md` | L2102-2180 |
| `dc-oauth-test-part2.md` | L9453-9507 |
| `dc-oauth-test-part2.md` | L8579-8633 |
| `dc-oauth-test-part2.md` | L4830-4890 |
| `dc-oauth-test-part2.md` | L2923-2986 |
| `dc-oauth-test-part2.md` | L4890-4934 |
| `dc-oauth-test-part2.md` | L9634-9668 |
| `dc-oauth-test-part2.md` | L3441-3512 |
| `dc-oauth-test.md` | L2032-2102 |
| `dc-oauth-test-part2.md` | L3691-3744 |
| `functions/index.js` | L18-44 |
| `dc-oauth-test-part3.md` | L564-627 |
| `dc-oauth-test.md` | L922-978 |

</details>

---

```diff
        await admin.firestore().collection("users").doc(discordUser.id).set(
          {
+           id: discordUser.id,
            username: discordUser.username,
-           discriminator: discordUser.discriminator,
-           avatar: `https://cdn.discordapp.com/avatars/${discordUser.id}/${discordUser.avatar}.png`,
-           guilds: guilds.map((guild) => ({
-             id: guild.id,
-             name: guild.name,
-             icon: guild.icon
-               ? `https://cdn.discordapp.com/icons/${guild.id}/${guild.icon}.png`
-               : null,
-             owner: guild.owner,
-             permissions: guild.permissions,
-           })),
-           lastLogin: admin.firestore.FieldValue.serverTimestamp(),
+           email: discordUser.email
          },
          {merge: true},
```

---

已經幫你完成後端 Firestore 寫入，只保留以下三個欄位：

- `id`（Discord 使用者 ID）
- `username`（Discord 使用者名稱）
- `email`（Discord 使用者 Email）

你只要重新部署 Cloud Functions，之後每次用戶登入，Firestore 的 `users` collection 就只會寫入這三個欄位。

如需進一步調整或測試，請隨時告訴我！

---

_**User**_

await admin.firestore().collection("users").doc(discordUser.id).set( 這一行的意思是在 firestore 裡面以 discord.id 創立文件的意思嗎?

---

_**Assistant**_

是的，你的理解完全正確！

這一行程式碼：

```js
await admin.firestore().collection("users").doc(discordUser.id).set(
  {
    id: discordUser.id,
    username: discordUser.username,
    email: discordUser.email
  },
  {merge: true},
);
```

**意思是：**

- 在 Firestore 的 `users` collection 裡，
- 以 `discordUser.id`（也就是 Discord 使用者的 ID）作為文件（document）的 ID，
- 寫入（或更新）這個文件的內容（這裡是 id、username、email 這三個欄位）。

如果這個文件已經存在，則會**更新**內容（因為有 `{merge: true}`，只會合併/覆蓋這三個欄位，不會刪除其他欄位）；如果不存在，則會**新建**一個文件。

---

### 例子

假設 Discord 回傳的 id 是 `1234567890`，那 Firestore 會有一個路徑：

```
users/1234567890
```

這個文件的內容會是：

```json
{
  "id": "1234567890",
  "username": "你的 Discord 名稱",
  "email": "你的 Discord email"
}
```

---

如有更多 Firestore 或 Cloud Functions 的問題，歡迎繼續提問！

---

_**User**_

那我可以用 username+id創立文件嗎?

---

_**Assistant**_

可以，你**可以用任何字串**作為 Firestore 文件的 ID，只要這個字串符合 Firestore 文件 ID 的規範（不能有 `/`、不能超過 1500 bytes 等）。

---

## 如何用 `username+id` 當文件 ID？

你可以這樣寫：

```js
const docId = `${discordUser.username}_${discordUser.id}`;
await admin.firestore().collection("users").doc(docId).set({
  id: discordUser.id,
  username: discordUser.username,
  email: discordUser.email
}, { merge: true });
```

這樣 Firestore 裡的文件路徑會變成：

```
users/用戶名_用戶ID
```

---

## 注意事項

1. **username 可能有特殊字元**  
   Discord username 可能包含空格、特殊符號，這些大多數都可以用於 Firestore 文件 ID，但不能有 `/`。
2. **username 可能會變**  
   用戶可以更改 username，如果你用 username+id 當文件 ID，未來用戶改名時，會產生新文件，舊資料不會自動合併。
3. **唯一性**  
   用 `id` 當文件 ID 已經保證唯一，通常不需要加 username。

---

## 建議

- **最佳實踐**：建議還是只用 `discordUser.id` 當文件 ID，username 當欄位存就好，這樣不會有用戶改名導致資料分散的問題。
- 如果你真的有特殊需求（例如要讓管理者用文件 ID 搜尋 username），可以用 `username_id`，但要注意上述風險。

---

如需範例程式碼或有其他需求，歡迎再問！

---

_**User**_

好吧，id 的唯一性比較好管理，還是用id就好了

---

_**Assistant**_

你的選擇非常正確！  
直接用 Discord 的 `id` 當 Firestore 文件 ID 是**最佳實踐**，原因如下：

- **唯一且不會變動**：Discord 的 id 是全域唯一且不會被用戶更改，最適合當作主鍵。
- **方便查找與管理**：未來你要查詢、更新、刪除這個用戶的資料都很方便。
- **避免重複與資料分散**：用 username 可能因為用戶改名而產生多份資料，id 不會有這個問題。

---

如果你有其他關於 Firestore 結構設計、Discord OAuth 或 Firebase 的問題，歡迎隨時再問！

---

